<%- include('../../partials/header', {title: 'Book Appointment'}) %>

<main class="main-content">
  <div class="page-header">
    <h1><i class="fas fa-calendar-plus"></i> Book Appointment</h1>
    <p>Schedule your appointment with <%= doctor.name %></p>
  </div>

  <div class="booking-container">
    <!-- Doctor Info Card -->
    <div class="doctor-info-card">
      <div class="doctor-avatar">
        <i class="fas fa-user-md"></i>
      </div>
      <div class="doctor-details">
        <h2><%= doctor.name %></h2>
        <p class="specialization"><i class="fas fa-stethoscope"></i> <%= doctor.specialization %></p>
        <p class="location"><i class="fas fa-map-marker-alt"></i> <%= doctor.location %></p>
        <p class="phone"><i class="fas fa-phone"></i> <%= doctor.phone %></p>
        <span class="status-badge available"><i class="fas fa-circle-check"></i> Available</span>
      </div>
    </div>

    <!-- Booking Form -->
    <div class="booking-form-card">
      <form id="bookingForm" class="booking-form">
        <input type="hidden" name="doctor_id" value="<%= doctor.id %>">

        <div class="form-group">
          <label for="patient_name"><i class="fas fa-user"></i> Full Name *</label>
          <input type="text" id="patient_name" name="patient_name" required>
        </div>

        <div class="form-group">
          <label for="patient_phone"><i class="fas fa-phone"></i> Phone Number *</label>
          <input type="tel" id="patient_phone" name="patient_phone" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="appointment_date"><i class="fas fa-calendar"></i> Date *</label>
            <input type="date" id="appointment_date" name="appointment_date" required>
          </div>

          <div class="form-group">
            <label for="appointment_time"><i class="fas fa-clock"></i> Time *</label>
            <select id="appointment_time" name="appointment_time" required>
              <option value="">Select Time</option>
              <option value="09:00">09:00 AM</option>
              <option value="09:30">09:30 AM</option>
              <option value="10:00">10:00 AM</option>
              <option value="10:30">10:30 AM</option>
              <option value="11:00">11:00 AM</option>
              <option value="11:30">11:30 AM</option>
              <option value="14:00">02:00 PM</option>
              <option value="14:30">02:30 PM</option>
              <option value="15:00">03:00 PM</option>
              <option value="15:30">03:30 PM</option>
              <option value="16:00">04:00 PM</option>
              <option value="16:30">04:30 PM</option>
              <option value="17:00">05:00 PM</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="symptoms"><i class="fas fa-notes-medical"></i> Symptoms/Reason for Visit</label>
          <textarea id="symptoms" name="symptoms" rows="4" placeholder="Describe your symptoms or reason for the visit..."></textarea>
        </div>

        <!-- ✅ Video Call Appointment Option -->
        <div class="form-group" style="border-top:1px solid #eee;padding-top:.8rem;margin-top:.6rem">
          <label style="display:flex;align-items:center;gap:.55rem;cursor:pointer">
            <input type="checkbox" id="is_video_call" name="is_video_call">
            <span><i class="fas fa-video"></i> Video Call Appointment (priority + token)</span>
          </label>
          <small class="muted">Video call bookings are highlighted to the doctor and get higher priority.</small>
        </div>

        <div class="form-row" id="tokenRow" style="display:none;">
          <div class="form-group">
            <label for="token_amount"><i class="fas fa-indian-rupee-sign"></i> Token Amount (₹)</label>
            <input type="number" id="token_amount" name="token_amount" min="1" value="99">
            <small class="muted">This is a non-refundable token for the priority video consultation.</small>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" onclick="history.back()" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-calendar-check"></i> Book Appointment
          </button>
        </div>
      </form>
    </div>
  </div>
</main>

<script>
// Set minimum date to today
document.getElementById('appointment_date').min = new Date().toISOString().split('T')[0];

// Toggle token amount row for video call
const chkVideo = document.getElementById('is_video_call');
const tokenRow = document.getElementById('tokenRow');
chkVideo.addEventListener('change', () => {
  tokenRow.style.display = chkVideo.checked ? '' : 'none';
});

// Handle booking form submission
document.getElementById('bookingForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const formData = new FormData(this);
  const bookingData = Object.fromEntries(formData);

  try {
    const res = await fetch('/api/book-appointment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(bookingData)
    });
    const data = await res.json();

    if (!data.success) {
      alert('❌ ' + (data.error || 'Failed to book appointment'));
      return;
    }

    // If video-call: perform mock payment, then redirect to My Appointments
    if (data.needPayment) {
      const pay = await fetch('/payments/mock-pay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ appointmentId: data.appointmentId, amount: data.tokenAmount })
      }).then(r => r.json());

      if (pay.success) {
        alert('✅ Token payment complete! Your video appointment is prioritized.');
        window.location.href = '/patient/appointments';
      } else {
        alert('❌ Payment failed. You can retry from My Appointments.');
      }
      return;
    }

    // Normal appointment flow
    alert('✅ ' + data.message);
    window.location.href = '/patient/appointments';
  } catch (error) {
    console.error('Error:', error);
    alert('❌ Network error. Please try again.');
  }
});
</script>

<%- include('../../partials/footer') %>
