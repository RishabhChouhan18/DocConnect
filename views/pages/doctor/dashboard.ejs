<%- include('../../partials/header', {title: 'Doctor Dashboard'}) %>

<main class="main-content">

  <div class="page-header">
    <h1><i class="fas fa-clipboard-list"></i> Doctor Dashboard</h1>
    <p>Manage appointments</p>
  </div>

  <div class="appointments-section">

    <table class="appointments-table">
      <thead>
        <tr>
          <th>Patient</th>
          <th>Doctor</th>
          <th>Date & Time</th>
          <th>Symptoms</th>
          <th>Status / Actions</th>
        </tr>
      </thead>

      <tbody id="appointmentTableBody">
        <% appointments.forEach(a => { %>

          <tr class="appointment-row" data-id="<%= a.id %>">

            <td>
              <strong><%= a.patient_name %></strong><br>
              <small><i class="fas fa-phone"></i> <%= a.patient_phone %></small>
            </td>

            <td>
              <strong><%= a.doctor_name %></strong>
            </td>

            <td>
              <strong><%= a.appointment_date %></strong><br>
              <small><%= a.appointment_time %></small>
            </td>

            <td><%= a.symptoms || "-" %></td>

            <td>
              <span class="status-badge status-<%= a.status %>"><%= a.status %></span>

              <% if (a.status === "pending") { %>
                <button class="accept-btn" onclick="confirmAction(<%= a.id %>, 'accepted')">
                  Accept
                </button>
                <button class="reject-btn" onclick="confirmAction(<%= a.id %>, 'rejected')">
                  Reject
                </button>
              <% } %>
            </td>

          </tr>

        <% }) %>
      </tbody>
    </table>

  </div>

</main>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const doctorId = "<%= doctor_id %>";
const socket = io();
socket.emit("join-doctor", doctorId);

/* ✅ Real-time DELETE */
socket.on("appointment:deleted", (data) => {
  const row = document.querySelector(`tr[data-id="${data.id}"]`);
  if (row) row.remove();
});

/* ✅ Confirm delete / accept / reject */
function confirmAction(id, status) {
  Swal.fire({
    title: status === 'accepted' ? "Accept appointment?" : "Reject appointment?",
    icon: status === 'accepted' ? "success" : "warning",
    showCancelButton: true,
    confirmButtonText: status === 'accepted' ? "Accept" : "Reject",
    confirmButtonColor: status === 'accepted' ? "#16a34a" : "#dc2626"
  }).then(result => {
    if (result.isConfirmed) updateStatus(id, status);
  });
}

function updateStatus(id, status) {
  fetch("/doctor/api/update-appointment", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ appointmentId: id, status })
  })
  .then(r => r.json())
  .then(d => {
    if (!d.success) return;

    Swal.fire({
      title: "Updated!",
      text: d.message,
      icon: "success",
      timer: 1500,
      showConfirmButton: false
    });

    socket.emit("appointment:statusUpdate", { id, status });

    setTimeout(() => location.reload(), 1200);
  });
}
</script>

<%- include('../../partials/footer') %>
